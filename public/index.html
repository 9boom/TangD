<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Game Style Map (Optimized)</title>
  
  <link rel="icon" type="/png" href="/favicon.png">
  <link rel="manifest" href="/manifest.json">

  <link href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" rel="stylesheet" />

  <style>
    body { margin: 0; padding: 0; overflow: hidden; background: #000; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }

    /* Player: ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏õ‡πá‡∏ô DOM ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Animation ‡πÅ‡∏ö‡∏ö CSS (Pulse) */
    .player {
      width: 20px;
      height: 20px;
      background: #00aaff;
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 0 15px rgba(0, 170, 255, 0.9);
      transition: all 0.1s ease; /* ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏±‡∏ö‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•‡∏Ç‡∏∂‡πâ‡∏ô */
    }

    /* Loading indicator */
    #status {
      position: absolute; top: 10px; left: 10px;
      background: rgba(0,0,0,0.7); color: #fff;
      padding: 5px 10px; border-radius: 4px;
      font-family: sans-serif; font-size: 12px;
      z-index: 10;
    }
  </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>

<script>
// 1. Setup Map
const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    sources: {
      carto: {
        type: 'raster',
        tiles: [
          'https://a.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png',
          'https://b.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png'
        ],
        tileSize: 256,
        attribution: '&copy; CartoDB'
      }
    },
    layers: [
      { id: 'carto-base', type: 'raster', source: 'carto', minzoom: 0, maxzoom: 22 }
    ]
  },
  center: [100.5018, 13.7563],
  zoom: 16,
  pitch: 60,
  bearing: -20,
  antialias: true // ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏û
});

map.addControl(new maplibregl.NavigationControl({ showCompass: true, showZoom: false }));

// =========================
// üî• PERFORMANCE TWEAK 1: ‡πÉ‡∏ä‡πâ GeoJSON + Layer ‡πÅ‡∏ó‡∏ô DOM Marker ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Object ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å
// =========================
map.on('load', () => {
  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞
  const binsData = {
    type: 'FeatureCollection',
    features: [
      { type: 'Feature', geometry: { type: 'Point', coordinates: [100.5030, 13.7570] } },
      { type: 'Feature', geometry: { type: 'Point', coordinates: [100.5005, 13.7555] } },
      { type: 'Feature', geometry: { type: 'Point', coordinates: [100.5022, 13.7548] } }
    ]
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° Source
  map.addSource('bins-source', {
    type: 'geojson',
    data: binsData
  });

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° Layer (‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏î‡πâ‡∏ß‡∏¢ GPU)
  map.addLayer({
    id: 'bins-layer',
    type: 'symbol',
    source: 'bins-source',
    layout: {
      'text-field': 'üóëÔ∏è', // ‡πÉ‡∏ä‡πâ‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥‡πÅ‡∏ó‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÇ‡∏´‡∏•‡∏î
      'text-size': 28,
      'text-allow-overlap': true
    },
    paint: {
      'text-opacity': 0.9
    }
  });
});

// =========================
// üî• PERFORMANCE TWEAK 2: Optimize Player Marker & Camera
// =========================

const playerEl = document.createElement('div');
playerEl.className = 'player';

// ‡∏™‡∏£‡πâ‡∏≤‡∏á Marker ‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Add)
const playerMarker = new maplibregl.Marker({
    element: playerEl,
    pitchAlignment: 'map' // ‡πÉ‡∏´‡πâ‡∏à‡∏∏‡∏î‡πÅ‡∏ö‡∏ô‡∏£‡∏≤‡∏ö‡πÑ‡∏õ‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô 3D ‡∏Ç‡∏∂‡πâ‡∏ô)
})
.setLngLat([0,0]); // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

let isFirstFix = true;
let lastUpdate = 0;

if (navigator.geolocation) {
  const geoOptions = {
    enableHighAccuracy: true,
    maximumAge: 1000, // ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏ß‡∏¥ (‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å GPS ‡∏ñ‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)
    timeout: 10000
  };

  const watchId = navigator.geolocation.watchPosition(
    (pos) => {
      const now = Date.now();
      // ‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (Throttle)
      if (now - lastUpdate < 500 && !isFirstFix) return; 
      lastUpdate = now;

      const { longitude, latitude, heading } = pos.coords;
      const userHeading = heading || 0; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏® ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0

      // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Marker (‡πÑ‡∏°‡πà create ‡πÉ‡∏´‡∏°‡πà)
      playerMarker.setLngLat([longitude, latitude]);

      // Add to map ‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      if (isFirstFix) {
        playerMarker.addTo(map);
        map.flyTo({ center: [longitude, latitude], zoom: 17 });
        isFirstFix = false;
      }

      // 2. ‡∏Ç‡∏¢‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏° (Check ‡∏ß‡πà‡∏≤ user ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≤‡∏Å‡πÅ‡∏°‡∏û‡∏≠‡∏¢‡∏π‡πà)
      if (!map.isMoving() || isFirstFix) {
         map.easeTo({
            center: [longitude, latitude],
            bearing: userHeading, // ‡∏´‡∏°‡∏∏‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏ô
            duration: 1000,       // ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÑ‡∏´‡∏•‡πÜ
            easing: t => t        // Linear easing ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
         });
      }
    },
    (err) => {
      console.error(err);
    },
    geoOptions
  );
} else {
  alert("Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation");
}

</script>

</body>
</html>