<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Map with Style & Compass</title>
  
  <link href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" rel="stylesheet" />

  <style>
    body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }

    /* Player Marker */
    .player {
      width: 20px;
      height: 20px;
      background: #00aaff;
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 0 15px rgba(0, 170, 255, 0.9);
      transition: all 0.1s ease;
      z-index: 100;
    }
    
    /* Cone of vision (‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏ö‡∏≠‡∏Å‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß Player ‡∏´‡∏±‡∏ô) */
    .player-heading {
        width: 0; 
        height: 0; 
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 20px solid rgba(0, 170, 255, 0.5);
        position: absolute;
        top: -25px;
        left: 0;
        transform-origin: bottom center;
        pointer-events: none;
    }

    /* UI Controls Container */
    .ui-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    /* Style Selector */
    select {
        padding: 8px;
        border-radius: 5px;
        border: none;
        background: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        font-size: 14px;
    }

    /* Compass Button */
    #compass-btn {
        padding: 10px;
        background: #fff;
        border: none;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        cursor: pointer;
        font-weight: bold;
        display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô iOS ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå */
    }
    #compass-btn.active {
        background: #00aaff;
        color: white;
    }

    #status {
      position: absolute; top: 10px; left: 10px;
      background: rgba(0,0,0,0.7); color: #fff;
      padding: 5px 10px; border-radius: 4px;
      font-size: 12px; z-index: 10;
    }
  </style>
</head>
<body>

<div id="status">Waiting for GPS...</div>
<div id="map"></div>

<div class="ui-controls">
    <select id="style-selector">
        <option value="light">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: ‡∏™‡∏ß‡πà‡∏≤‡∏á (Light)</option>
        <option value="dark">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: ‡∏°‡∏∑‡∏î (Dark)</option>
        <option value="satellite">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: ‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Satellite)</option>
    </select>
    <button id="compass-btn">‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏®</button>
</div>

<script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>

<script>
// =========================
// 1. Defind Styles Definitions
// =========================
const styles = {
    light: {
        version: 8,
        sources: {
            'raster-tiles': {
                type: 'raster',
                tiles: ['https://a.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png'],
                tileSize: 256,
                attribution: '&copy; CartoDB'
            }
        },
        layers: [{ id: 'simple-tiles', type: 'raster', source: 'raster-tiles', minzoom: 0, maxzoom: 22 }]
    },
    dark: {
        version: 8,
        sources: {
            'raster-tiles': {
                type: 'raster',
                tiles: ['https://a.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png'],
                tileSize: 256,
                attribution: '&copy; CartoDB'
            }
        },
        layers: [{ id: 'simple-tiles', type: 'raster', source: 'raster-tiles', minzoom: 0, maxzoom: 22 }]
    },
    satellite: {
        version: 8,
        sources: {
            'raster-tiles': {
                type: 'raster',
                // ‡πÉ‡∏ä‡πâ Esri World Imagery (‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏∞‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)
                tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
                tileSize: 256,
                attribution: '&copy; Esri'
            }
        },
        layers: [{ id: 'simple-tiles', type: 'raster', source: 'raster-tiles', minzoom: 0, maxzoom: 22 }]
    }
};

// =========================
// 2. Setup Map
// =========================
const map = new maplibregl.Map({
  container: 'map',
  style: styles.light, // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Light
  center: [100.5018, 13.7563],
  zoom: 17,
  pitch: 60,
  bearing: 0,
  antialias: true
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î Layer ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞) ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
// ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Style ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
function addGameLayers() {
    if (map.getSource('bins-source')) return; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ã‡πâ‡∏≥

    const binsData = {
        type: 'FeatureCollection',
        features: [
            { type: 'Feature', geometry: { type: 'Point', coordinates: [100.5030, 13.7570] } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [100.5005, 13.7555] } },
            { type: 'Feature', geometry: { type: 'Point', coordinates: [100.5022, 13.7548] } }
        ]
    };

    map.addSource('bins-source', { type: 'geojson', data: binsData });
    
    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ï‡∏≤‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏∑‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏≤‡∏ß)
    const isDark = document.getElementById('style-selector').value === 'satellite' || document.getElementById('style-selector').value === 'dark';
    
    map.addLayer({
        id: 'bins-layer',
        type: 'symbol',
        source: 'bins-source',
        layout: {
            'text-field': 'üóëÔ∏è',
            'text-size': 28,
            'text-allow-overlap': true,
            'text-offset': [0, -0.5] // ‡∏•‡∏≠‡∏¢‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢
        },
        paint: {
            'text-opacity': 0.9,
            'text-halo-color': isDark ? '#000' : '#fff',
            'text-halo-width': 2
        }
    });
}

// Event ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Map ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Style ‡πÄ‡∏™‡∏£‡πá‡∏à
map.on('load', addGameLayers);
map.on('style.load', addGameLayers); // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Style

// Logic ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Style
document.getElementById('style-selector').addEventListener('change', (e) => {
    const selectedStyle = styles[e.target.value];
    map.setStyle(selectedStyle);
});


// =========================
// 3. Player & Geolocation
// =========================
const playerEl = document.createElement('div');
playerEl.className = 'player';
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏ö‡∏≠‡∏Å‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà Player ‡∏´‡∏±‡∏ô
const headingEl = document.createElement('div');
headingEl.className = 'player-heading';
playerEl.appendChild(headingEl);

const playerMarker = new maplibregl.Marker({
    element: playerEl,
    pitchAlignment: 'map',
    rotationAlignment: 'map' // ‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏∏‡∏ô‡πÑ‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
}).setLngLat([0,0]);

let currentPos = { lng: 0, lat: 0 };
let isFirstFix = true;

if (navigator.geolocation) {
    navigator.geolocation.watchPosition((pos) => {
        const { longitude, latitude } = pos.coords;
        currentPos = { lng: longitude, lat: latitude };
        
        document.getElementById('status').innerText = `GPS: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;

        playerMarker.setLngLat([longitude, latitude]);

        if (isFirstFix) {
            playerMarker.addTo(map);
            map.flyTo({ center: [longitude, latitude], zoom: 17 });
            isFirstFix = false;
        }

        // ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏´‡∏°‡∏∏‡∏ô Bearing ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏®‡πÅ‡∏ó‡∏ô)
        if (!map.isMoving() && compassModeEnabled) {
             map.easeTo({
                center: [longitude, latitude],
                duration: 500
             });
        }
    }, (err) => console.error(err), { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 });
}

// =========================
// 4. Compass / Device Orientation Logic
// =========================
let compassModeEnabled = false;
const compassBtn = document.getElementById('compass-btn');

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô iOS 13+ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠ Permission)
if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    compassBtn.style.display = 'block'; // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏î
} else if (window.DeviceOrientationEvent) {
    // Android ‡∏´‡∏£‡∏∑‡∏≠ iOS ‡∏£‡∏∏‡πà‡∏ô‡πÄ‡∏Å‡πà‡∏≤ ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢
    compassBtn.style.display = 'block';
    // initCompass(); // ‡∏ö‡∏≤‡∏á browser ‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏¢ ‡πÅ‡∏ï‡πà‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°
}

compassBtn.addEventListener('click', () => {
    initCompass();
});

function initCompass() {
    // 1. ‡∏Å‡∏£‡∏ì‡∏µ iOS 13+
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
            .then(response => {
                if (response === 'granted') {
                    enableCompassListener();
                } else {
                    alert('Permission denied');
                }
            })
            .catch(console.error);
    } else {
        // 2. Android / Non-iOS
        enableCompassListener();
    }
}

function enableCompassListener() {
    compassModeEnabled = true;
    compassBtn.classList.add('active');
    compassBtn.innerText = "Compass ON";
    
    window.addEventListener('deviceorientation', handleOrientation);
}

let lastCompassUpdate = 0;

function handleOrientation(event) {
    // Throttle: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 30 fps ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÅ‡∏ö‡∏ï‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å
    const now = Date.now();
    if (now - lastCompassUpdate < 30) return;
    lastCompassUpdate = now;

    let compassHeading = 0;

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á (Logic ‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á iOS ‡πÅ‡∏•‡∏∞ Android)
    if (event.webkitCompassHeading) {
        // iOS
        compassHeading = event.webkitCompassHeading;
    } else {
        // Android (‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å alpha)
        // alpha ‡∏Ñ‡∏∑‡∏≠ 0 ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ô‡πÑ‡∏õ‡∏ó‡∏¥‡∏®‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ (‡πÉ‡∏ô‡∏ö‡∏≤‡∏á device) ‡πÅ‡∏ï‡πà‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏ß‡πà‡∏≤
        // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Android
        compassHeading = 360 - event.alpha;
    }

    // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0-360
    if (compassHeading < 0) compassHeading += 360;
    if (compassHeading >= 360) compassHeading -= 360;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Map Bearing (‡∏´‡∏°‡∏∏‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
    // ‡πÉ‡∏ä‡πâ easeTo ‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•
    map.easeTo({
        bearing: compassHeading,
        duration: 100, // ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏±‡πâ‡∏ô‡∏°‡∏≤‡∏Å‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å Realtime
        easing: t => t // Linear
    });

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Status
    // document.getElementById('status').innerText += ` | Head: ${Math.round(compassHeading)}¬∞`;
}

</script>

</body>
</html>